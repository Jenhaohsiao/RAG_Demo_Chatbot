openapi: 3.0.3
info:
  title: RAG Chatbot - Session Management API
  description: API for creating, managing, and closing chat sessions with automatic TTL cleanup
  version: 1.0.0
  contact:
    name: RAG Demo Chatbot
    email: jenhao.hsiao@gmail.com

servers:
  - url: http://localhost:8000/api/v1
    description: Development server
  - url: https://api.ragchatbot.example.com/api/v1
    description: Production server (Together.ai deployment)

tags:
  - name: session
    description: Session lifecycle management

paths:
  /session/create:
    post:
      tags:
        - session
      summary: Create new chat session
      description: |
        Creates a new isolated chat session with unique ID and dedicated Qdrant collection.
        Session automatically expires after 30 minutes of inactivity.
      operationId: createSession
      responses:
        '201':
          description: Session created successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SessionResponse'
              example:
                session_id: "a1b2c3d4-e5f6-7890-abcd-ef1234567890"
                created_at: "2025-12-08T10:30:00Z"
                expires_at: "2025-12-08T11:00:00Z"
                state: "READY_FOR_UPLOAD"
                qdrant_collection_name: "session_a1b2c3d4-e5f6-7890-abcd-ef1234567890"
                vector_count: 0
                document_count: 0
                language: "en"
        '500':
          $ref: '#/components/responses/InternalServerError'

  /session/{session_id}:
    get:
      tags:
        - session
      summary: Get session status
      description: Retrieve current session state, metrics, and TTL information
      operationId: getSession
      parameters:
        - $ref: '#/components/parameters/SessionIdPath'
      responses:
        '200':
          description: Session found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SessionResponse'
        '404':
          $ref: '#/components/responses/SessionNotFound'
        '410':
          $ref: '#/components/responses/SessionExpired'

  /session/{session_id}/heartbeat:
    post:
      tags:
        - session
      summary: Update session activity timestamp
      description: Resets the last_activity timestamp to prevent TTL expiration
      operationId: sessionHeartbeat
      parameters:
        - $ref: '#/components/parameters/SessionIdPath'
      responses:
        '200':
          description: Heartbeat recorded
          content:
            application/json:
              schema:
                type: object
                properties:
                  last_activity:
                    type: string
                    format: date-time
                  expires_at:
                    type: string
                    format: date-time
        '404':
          $ref: '#/components/responses/SessionNotFound'
        '410':
          $ref: '#/components/responses/SessionExpired'

  /session/{session_id}/close:
    post:
      tags:
        - session
      summary: Manually close session
      description: |
        Immediately terminates session, deletes Qdrant collection, and cleans up all data.
        Triggered by user clicking "Leave" button.
      operationId: closeSession
      parameters:
        - $ref: '#/components/parameters/SessionIdPath'
      responses:
        '200':
          description: Session closed successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: "Session closed and data deleted"
                  deleted_vector_count:
                    type: integer
                    example: 42
        '404':
          $ref: '#/components/responses/SessionNotFound'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /session/{session_id}/restart:
    post:
      tags:
        - session
      summary: Restart session
      description: |
        Closes current session and creates a new one.
        Triggered by user clicking "Restart" button.
      operationId: restartSession
      parameters:
        - $ref: '#/components/parameters/SessionIdPath'
      responses:
        '201':
          description: Session restarted
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SessionResponse'
        '404':
          $ref: '#/components/responses/SessionNotFound'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /session/{session_id}/language:
    put:
      tags:
        - session
      summary: Update UI language preference
      description: Changes the current language for UI elements (does not affect chat history)
      operationId: updateLanguage
      parameters:
        - $ref: '#/components/parameters/SessionIdPath'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                language_code:
                  type: string
                  enum: [en, zh, ko, es, ja, ar, fr]
                  description: ISO 639-1 language code
              required:
                - language_code
            example:
              language_code: "zh"
      responses:
        '200':
          description: Language updated
          content:
            application/json:
              schema:
                type: object
                properties:
                  language_code:
                    type: string
                  language_name:
                    type: string
                  changed_at:
                    type: string
                    format: date-time
              example:
                language_code: "zh"
                language_name: "中文"
                changed_at: "2025-12-08T10:35:00Z"
        '400':
          description: Invalid language code
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              example:
                error_code: "INVALID_LANGUAGE"
                message: "Language code must be one of: en, zh, ko, es, ja, ar, fr"
        '404':
          $ref: '#/components/responses/SessionNotFound'

components:
  parameters:
    SessionIdPath:
      name: session_id
      in: path
      required: true
      description: UUID of the session
      schema:
        type: string
        format: uuid
      example: "a1b2c3d4-e5f6-7890-abcd-ef1234567890"

  schemas:
    SessionResponse:
      type: object
      required:
        - session_id
        - created_at
        - last_activity
        - expires_at
        - state
        - qdrant_collection_name
        - vector_count
        - document_count
        - language
      properties:
        session_id:
          type: string
          format: uuid
          description: Unique session identifier
        created_at:
          type: string
          format: date-time
          description: Session creation timestamp
        last_activity:
          type: string
          format: date-time
          description: Last user interaction timestamp
        expires_at:
          type: string
          format: date-time
          description: Automatic expiration timestamp (created_at + 30 minutes)
        state:
          type: string
          enum:
            - INITIALIZING
            - READY_FOR_UPLOAD
            - PROCESSING
            - ERROR
            - READY_FOR_CHAT
            - CHATTING
          description: Current session state
        qdrant_collection_name:
          type: string
          description: Associated Qdrant collection name
          pattern: "^session_[a-f0-9-]+$"
        vector_count:
          type: integer
          minimum: 0
          description: Total vectors stored in collection
        document_count:
          type: integer
          minimum: 0
          description: Number of uploaded documents
        language:
          type: string
          enum: [en, zh, ko, es, ja, ar, fr]
          description: Current UI language preference

    Error:
      type: object
      required:
        - error_code
        - message
      properties:
        error_code:
          type: string
          description: Machine-readable error code
        message:
          type: string
          description: Human-readable error message
        details:
          type: object
          description: Additional error context

  responses:
    SessionNotFound:
      description: Session not found
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          example:
            error_code: "SESSION_NOT_FOUND"
            message: "Session does not exist or has been deleted"

    SessionExpired:
      description: Session has expired
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          example:
            error_code: "SESSION_EXPIRED"
            message: "Session expired due to 30-minute inactivity timeout"

    InternalServerError:
      description: Internal server error
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          example:
            error_code: "INTERNAL_ERROR"
            message: "An unexpected error occurred"
